# Проект Dealer-Bot
Приложение использует **Laravel 10** с **nWidart/laravel-modules** для модульной архитектуры, **tymon/jwt-auth** для аутентификации на основе токенов и **spatie/laravel-permission** для управления ролями и разрешениями.

## Обзор
- **Фреймворк**: Laravel 10
- **Модульность**: Использует [nWidart/laravel-modules](https://nwidart.com/laravel-modules/v6/introduction)
- **Аутентификация**: JWT через [tymon/jwt-auth](https://github.com/tymondesigns/jwt-auth)
- **Контроль доступа**: [spatie/laravel-permission](https://github.com/spatie/laravel-permission)
- **База данных**: MySQL

## Системные требования
- **PHP** >= 8.2
- **Composer** для управления зависимостями
- **MySQL** сервер
- **Redis** (рекомендуется для очередей и кеширования)
- **Минимум 1 процессор и 1 ГБ ОЗУ**

## Конфигурация окружения
### Генерация ключей и настройка окружения
```bash
php artisan key:generate
php artisan jwt:secret
```

### Создание символической ссылки на хранилище
```bash
php artisan storage:link
```

## Миграции базы данных и заполнение данных
### Запуск миграций
```bash
php artisan migrate
```

Если используются модули:
```bash
php artisan module:migrate
```

### Заполнение данных (Seeder)
```bash
php artisan module:seed UserManagement
```

### Генерация Swagger документации
```bash
php artisan swagger:generate
```

## Очереди и Планировщик
### Запуск обработчика очередей
```bash
php artisan queue:work --daemon
```

### Планировщик (Cron)
```bash
* * * * * php artisan schedule:run >> /dev/null 2>&1
```

# CI/CD Развертывание

Этот документ описывает процесс автоматической сборки и развертывания (CI/CD) проекта **Dealer-Bot** в тестовом окружении. Проект **ещё не запущен в продакшен**, поэтому текущая документация актуальна только для тестовой среды.

## Структура CI/CD в GitLab

CI/CD пайплайн состоит из двух основных стадий:

1. **Build (Сборка)** – создание Docker-образа и его загрузка в GitLab Container Registry.
2. **Deploy (Развертывание)** – развёртывание контейнера с приложением на сервере.

## Стадия Build (Сборка)

- Для сборки используется `Dockerfile2`. В этом файле указан базовый образ, содержащий необходимые системные библиотеки и драйверы для PHP 8.2.
- Все файлы проекта копируются в контейнер, после чего запускается `build.sh`, который:
  - Устанавливает зависимости через `Composer`.
  - Подготавливает файлы для работы приложения.
- После успешной сборки Docker-образ загружается в GitLab Container Registry.
- Для аутентификации в GitLab Container Registry используются учетные данные пользователя, запустившего CI/CD job.

## Стадия Deploy (Развертывание)

- Развёртывание осуществляется с использованием **Docker-контейнера**.
- В пайплайне используется специальный **GitLab Runner с Docker Executor**, который имеет доступ к `docker daemon` на сервере.
- Запускается скрипт `deploy.sh`, который выполняет следующие действия:
  - Авторизуется в GitLab Container Registry.
  - Загружает подготовленный образ.
  - Проверяет наличие запущенного контейнера:
    - Если контейнер уже работает, он останавливается и заменяется новой версией.
    - Если контейнера нет, создаётся новый экземпляр.
- Внутри контейнера запускается `docker-entrypoint.sh`, который:
  - Выполняет миграции базы данных Laravel.
  - Генерирует Swagger-документацию.
  - Запускает cronjob
  - Кэширует конфигурации и маршруты Laravel.
  - Запускает Nginx и PHP-FPM.
- После успешного запуска приложение доступно по следующим адресам:
  - [Домен](https://dealerbot.stemdev.uz)
  - [IP](http://185.185.71.178:8050)

## Управление секретами

- Файл `.env` не хранится в репозитории.
- На сервере `.env` расположен по пути: `/opt/projects/dealer-bot/.env`.
- Изменение переменных окружения требует доступа к серверу.

## Мониторинг и Логирование

- После успешного развертывания необходимо подождать 1-3 минуты, прежде чем проверять работоспособность сервиса.
- Если через 3 минуты сервис не работает, необходимо проверить логи в [Grafana](https://grafana.stemdev.uz).
- В случае неудачного развертывания GitLab автоматически отправляет уведомление на email разработчика, который запустил пайплайн.

## Откат (Rollback)

- Если после развертывания возникли ошибки, можно выполнить откат к предыдущей версии через откат коммита.
- После отката GitLab автоматически запустит процесс развертывания предыдущей версии.

## Важные правила

- Не изменяйте файл `.gitlab-ci.yml`!
- Если необходимо внести изменения в процесс CI/CD, обратитесь в поддержку.
- Для работы CI/CD вам нужен хотя бы **"Reporter"** доступ к шаблонному проекту CI/CD (`apps/common/ci-template`). В противном случае возникнет ошибка:
  ```
  Project `apps/common/ci-template` not found or access denied! Make sure any includes in the pipeline configuration are correctly defined.
  ```
- Для работы с тестовой средой категорически рекомендуется использовать только ветки `testing`.
- Если требуется добавить, удалить или изменить команды, выполняющие задачи, аналогичные `php artisan migrate` или другие команды Laravel, они расположены в файле `docker-entrypoint.sh` внутри функции `run_laravel_tasks`

## Дополнительные ссылки

- Документация по логированию в Grafana *(в разработке)*
- Документация по CI/CD шаблонам *(в разработке)*
- Контакт для поддержки CI/CD: `absalomoop2@gmail.com`

